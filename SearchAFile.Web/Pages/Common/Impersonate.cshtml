@page
@model SearchAFile.Web.Pages.Common.ImpersonateModel
@{

}

<form id="objForm" method="post" onsubmit="$('#btnSubmit').prop('disabled', $(this).valid()); $('#btnEnd').prop('disabled', $(this).valid());">
    
    <div id="divValidationSummary" asp-validation-summary="All" hidden></div>

    <div class="card m-auto p-0" style="max-width: 40rem;">

        <div class="card-header align-items-center m-0 cus-bg-primary cus-no-select" style="border-bottom: 2px solid var(--secondary-color);">
            <label class="cus-text-secondary-text-no-hover">
                <i class="fa-solid fa-user-secret"></i>
                &nbsp;
                Impersonate User
            </label>
        </div>

        <div class="card-body cus-bootstrap-table-striped p-0">

            <div class="row align-items-center m-0">
                <div class="cus-col col-12">
                    <div class="form-floating">
                        <div class="form-control" style="height: 100%; min-height: 5rem;">
                            <div class="input-group dropdown">
                                <button id="ddlUser" class="btn cus-btn-outline-primary cus-dropdown-button form-control rounded text-start d-flex" type="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false" onclick="if (!is_mobile || focus_on_mobile) { setTimeout(function () { $('#txtSearchUser').focus(); }, 500); }">
                                    <span id="lblSelectedItem" class="cus-dropdown-selected-item w-100" style="font-size: smaller; line-height: 1.25rem;">-User-</span>
                                    <i class="fa-solid fa-chevron-down cus-dropdown-chevron"></i>
                                </button>
                                <div class="dropdown-menu" aria-labelledby="ddlUser">
                                    <div style="border-bottom: 2px solid lightgray;">
                                        <input id="txtSearchUser" type="text" class="cus-dropdown-search w-100" placeholder="Search User (@Model.Users?.Count())" maxlength="100" style="height: 2rem !important; padding-right: 2rem !important;" />
                                    </div>
                                    <div style="max-height: 17.5rem; overflow-y: auto;">
                                        <div id="divUser" class="cus-no-select" style="cursor: pointer; min-width: fit-content; width: 100%;">
                                            @if (Model.Users.Any())
                                            {
                                                @foreach (var item in Model.Users)
                                                {
                                                    string strBadge = "cus-bg-secondary";

                                                    @switch (item.Role)
                                                    {
                                                        case "System Admin":

                                                            strBadge = "bg-danger";
                                                            break;

                                                        case "Admin":

                                                            strBadge = "bg-warning";
                                                            break;

                                                        case "Program Admin":

                                                            strBadge = "cus-bg-primary";
                                                            break;
                                                    }

                                                    string strUser = item?.Company?.Company1 + " - " + item?.FullName + " <span class='badge float-end " + strBadge + "' style='width: 7rem; '>" + item?.Role + "</span>";

                                                    <div tabindex="0" class="dropdown-item cus-dropdown-item" onclick="$('#ddlUser').removeClass('input-validation-error'); $('#lblSelectedItem').html('@strUser.EscapeJsString()'); $('#hdnItemID').val('@item?.UserId');" style="white-space: nowrap;">
                                                        <div class="d-flex">
                                                            <span>@item?.Company?.Company1 - @item?.FullName</span>
                                                            <span class="ms-auto ps-1">
                                                                <span class="badge @strBadge" style="width: 7rem;">@item?.Role</span>
                                                                @if (Convert.ToBoolean(item?.Active))
                                                                {
                                                                    <i class="fa-solid fa-circle-check text-success" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Active"></i>
                                                                }
                                                                else
                                                                {
                                                                    <i class="fa-solid fa-circle-xmark text-danger" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Inactive"></i>
                                                                }
                                                                <i class="fa-solid fa-level-up fa-solid fa-level-up align-self-center ps-1"></i>
                                                            </span>
                                                        </div>
                                                    </div>
                                                }
                                            }
                                            else
                                            {
                                                <div class="px-2 py-1 cus-no-select">
                                                    <i class="text-secondary" style="cursor: context-menu;">No existing  user</i>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <label class="fw-bold" for="ddlUser">@Html.DisplayNameFor(model => model.id)</label>
                        <input id="hdnItemID" type="hidden" asp-for="id" value="" />
                    </div>
                </div>
            </div>

        </div>

        <div class="card-footer text-center cus-no-select">
            <button id="btnSubmit" type="submit" class="btn btn-outline-success" onclick="return Impersonate();" style="min-width: 30%;">
                <span id="lblSubmit" style="color: unset;">
                    Impersonate
                    <i class="fa-solid fa-right-to-bracket"></i>
                </span>
                <img id="imgSubmit" src="~/SystemFiles/loading.gif" style="display: none; height: 20px; width: 20px;" />
            </button>
        </div>
    </div>

</form>

@section Scripts
{
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}

    <script type="text/javascript">

        $(document).on('show.bs.dropdown', '.dropdown', function () {

            const dropdownMenu = $(this).find('.dropdown-menu'); // Use class for generic targeting
            const dropdownButton = $(this).find('.cus-dropdown-button'); // Assuming this is the button triggering the dropdown

            // Set the width of the dropdown menu to match the button
            dropdownMenu.css({
                width: dropdownButton.outerWidth(),
            });
        });

        $(document).not('#txtSearchUser').on('keypress', function (event) {

            let keycode = (event.keyCode ? event.keyCode : event.which);

            if (keycode == '13') {

                event.preventDefault();
                $('#btnSubmit').click();
            }
        });

        $('#txtSearchUser').on('keypress', function (event) {

            let keycode = (event.keyCode ? event.keyCode : event.which);

            if (keycode == '13') {

                event.preventDefault();
                ReloadUser();
            }
        });

        function Impersonate() {

            // Clear out the messages.
            window.top.ClearToast();

            // Validate the page.
            $('#objForm').validate();

            // Is the form valid?
            let booIsValid = $('#objForm').valid();

            let strMessage = '';

            if ($('#hdnItemID').val() == '') {

                strMessage += '<li>User is required.</li>';
                $('#ddlUser').addClass('input-validation-error');
            }
            else {

                $('#ddlUser').removeClass('input-validation-error');
            }

            if (strMessage != '') {

                if (booIsValid) {

                    $('#divValidationSummary').html("<ul>" + strMessage + '</ul>');
                }
                else {

                    $("#divValidationSummary > ul").append(strMessage);
                }

                booIsValid = false;
            }

            if (!booIsValid) {

                // Output the errors.
                 window.top.ShowToast("danger", "The following errors have occured", $('#divValidationSummary').html(), 0, false);
            }
            else {

                $('#lblSubmit').toggle();
                $('#imgSubmit').toggle();
            }

            return booIsValid;
        }

        OnKeyUpAfter($('#txtSearchUser'), 'ReloadUser()', 500);

        function ReloadUser() {

            $('#txtSearchUser').removeClass('ui-autocomplete-complete');
            $('#txtSearchUser').addClass('ui-autocomplete-loading');

            $('#divUser').load(PageURL + '?handler=ReloadUser&search=' + encodeURIComponent($('#txtSearchUser').val()) + ' #divUser>*', function (response, status, xhr) {
            //$('#divUser').load(PageURL + '?handler=ReloadUser #divUser>*', function (response, status, xhr) {

                if (status == "error") {

                    window.top.ClearToast();
                    window.top.ShowToast('danger', 'Error!', xhr.responseText, 0, false);
                    return;
                }

                $('#txtSearchUser').removeClass('ui-autocomplete-loading');

                if ($('#txtSearchUser').val() != '') {

                    $('#txtSearchUser').addClass('ui-autocomplete-complete');
                }
            });
        }

    </script>

}